# 복합 필터 시스템 가이드

ComfyUI Image Manager의 고급 필터 시스템 사용 가이드입니다.

## 🎯 복합 필터 시스템이란?

**PoE(Path of Exile) 스타일 복합 필터 시스템**은 여러 조건을 조합하여 정교한 이미지 검색과 자동 수집을 가능하게 합니다.

### 핵심 개념

복합 필터는 **3가지 그룹 타입**을 제공하며, 각 그룹은 **정해진 순서대로 실행**됩니다:

```
실행 순서: 제외(NOT) → OR → AND
```

1. **제외(NOT) 그룹** - 원하지 않는 이미지를 먼저 걸러냅니다 (최우선 실행)
2. **OR 그룹** - 조건 중 하나라도 만족하면 포함됩니다
3. **AND 그룹** - 모든 조건을 만족해야 포함됩니다

## 📊 필터 그룹 타입 상세 설명

### 1. 제외(NOT) 그룹

**목적**: 원하지 않는 이미지를 결과에서 제외

**동작 방식**:
- 가장 먼저 실행되어 해당 조건에 맞는 이미지를 걸러냅니다
- 여러 제외 조건이 있으면 **하나라도 만족하면 제외**됩니다
- 다른 그룹보다 우선 적용되므로 효율적입니다

**사용 예시**:
- `nsfw` 태그가 있는 이미지 제외
- `low quality` 태그가 있는 이미지 제외
- 특정 AI 도구로 생성된 이미지 제외

### 2. OR 그룹

**목적**: 여러 조건 중 하나만 만족해도 포함

**동작 방식**:
- 제외 그룹 실행 후 남은 이미지를 대상으로 실행
- 여러 OR 조건이 있으면 **하나라도 만족하면 포함**됩니다
- 넓은 범위의 이미지를 선택할 때 유용

**사용 예시**:
- `1girl` 또는 `2girls` 태그가 있는 이미지
- `landscape` 또는 `cityscape` 태그가 있는 이미지
- 여러 캐릭터 중 하나라도 포함된 이미지

### 3. AND 그룹

**목적**: 모든 조건을 만족하는 이미지만 포함

**동작 방식**:
- OR 그룹 실행 후 남은 이미지를 대상으로 실행
- 여러 AND 조건이 있으면 **모두 만족해야 포함**됩니다
- 매우 정교한 필터링이 가능합니다

**사용 예시**:
- `캐릭터가 있음` AND `high quality` 태그
- `outdoors` 태그 AND `day` 태그
- 특정 모델 AND 특정 Rating

## 🔧 필터 조건 타입

### 긍정 프롬프트 (Positive Prompt)

#### 포함 (Contains)
- **설명**: 프롬프트에 특정 텍스트가 포함되어 있는지 확인
- **대소문자**: 구분하지 않음
- **예시**: `masterpiece` 입력 → "masterpiece, best quality" 프롬프트 매칭

#### 정규식 (Regex)
- **설명**: 정규 표현식 패턴을 사용한 고급 검색
- **예시**:
  - `^\d+girl` → 1girl, 2girls 등 매칭
  - `cat|dog` → cat 또는 dog 포함

### 네거티브 프롬프트 (Negative Prompt)

#### 포함 (Contains)
- **설명**: 네거티브 프롬프트에 특정 텍스트가 포함되어 있는지 확인
- **예시**: `nsfw` 입력 → "nsfw, lowres" 네거티브 프롬프트 매칭

#### 정규식 (Regex)
- **설명**: 정규 표현식을 사용한 네거티브 프롬프트 검색
- **예시**: `low.*quality` → "low quality", "low res quality" 등 매칭

### 자동태그 (Auto Tag)

WD Tagger로 생성된 자동 태그를 기반으로 필터링합니다.

#### 자동태그 존재
- **설명**: 이미지에 자동태그가 있는지 여부 확인
- **값**: 있음 / 없음
- **사용 시나리오**: WD Tagger로 분석된 이미지만 선택

#### 캐릭터 존재
- **설명**: 이미지에 캐릭터 태그가 있는지 확인
- **값**: 있음 / 없음
- **사용 시나리오**: 캐릭터가 포함된 이미지만 선택

#### Rating 타입
- **설명**: 이미지 등급 타입 확인
- **옵션**:
  - `general`: 일반 등급
  - `sensitive`: 민감한 콘텐츠
  - `questionable`: 의심스러운 콘텐츠
  - `explicit`: 성인 콘텐츠
- **점수 범위**: 0.0 ~ 1.0 (신뢰도)
- **예시**: Rating이 `general`이고 점수가 0.7 이상인 이미지

#### Rating 점수
- **설명**: 이미지의 전체 Rating 점수 확인
- **점수 범위**: 0.0 ~ 1.0
- **사용 시나리오**: 신뢰도가 높은 Rating을 가진 이미지 선택

#### General 태그
- **설명**: 특정 General 태그 포함 여부 확인
- **입력**: 태그 이름 (예: `1girl`, `solo`, `long hair`)
- **점수 범위**: 0.0 ~ 1.0 (태그 신뢰도)
- **예시**: `1girl` 태그가 0.5 이상의 신뢰도로 있는 이미지

#### Character 태그
- **설명**: 특정 캐릭터 태그 포함 여부 확인
- **입력**: 캐릭터 이름
- **점수 범위**: 0.0 ~ 1.0 (캐릭터 인식 신뢰도)
- **예시**: 특정 캐릭터가 0.75 이상의 신뢰도로 인식된 이미지

#### 모델
- **설명**: 특정 WD Tagger 모델로 분석된 이미지 확인
- **입력**: 모델 이름 (예: `wd-v1-4-vit-tagger-v2`)
- **사용 시나리오**: 특정 모델로 분석된 이미지만 선택

### 기본 조건 (Basic)

#### AI 도구
- **설명**: 이미지를 생성한 AI 도구 확인
- **입력**: 도구 이름 (예: `ComfyUI`, `NovelAI`, `Stable Diffusion`)
- **사용 시나리오**: 특정 도구로 생성된 이미지만 선택

#### 모델명
- **설명**: 이미지 생성에 사용된 AI 모델 확인
- **입력**: 모델 이름 또는 일부 (예: `animagine`, `pony`)
- **대소문자**: 구분하지 않음
- **부분 매칭**: 지원

## 💡 실전 사용 예시

### 예시 1: 고품질 캐릭터 이미지만 수집

**목표**: nsfw 제외, 1girl 또는 2girls, 캐릭터 있음, general rating

**필터 구성**:
1. **제외 그룹**: General 태그 `nsfw` (점수 0.0 ~ 1.0)
2. **OR 그룹**: General 태그 `1girl` (점수 0.5 ~ 1.0)
3. **OR 그룹**: General 태그 `2girls` (점수 0.5 ~ 1.0)
4. **AND 그룹**: 캐릭터 존재 = 있음
5. **AND 그룹**: Rating 타입 = `general` (점수 0.7 ~ 1.0)

### 예시 2: 특정 캐릭터의 고품질 이미지

**목표**: 특정 캐릭터, 고품질, low quality 제외

**필터 구성**:
1. **제외 그룹**: General 태그 `low quality`
2. **제외 그룹**: General 태그 `lowres`
3. **AND 그룹**: Character 태그 `hatsune miku` (점수 0.8 ~ 1.0)
4. **AND 그룹**: General 태그 `masterpiece` (점수 0.5 ~ 1.0)

### 예시 3: 풍경 이미지만 선택

**목표**: 사람 제외, 풍경 관련 태그

**필터 구성**:
1. **제외 그룹**: General 태그 `1girl`
2. **제외 그룹**: General 태그 `1boy`
3. **OR 그룹**: General 태그 `landscape`
4. **OR 그룹**: General 태그 `scenery`
5. **OR 그룹**: General 태그 `cityscape`

### 예시 4: ComfyUI로 생성한 특정 모델 이미지

**목표**: ComfyUI 도구, 특정 모델, 고품질

**필터 구성**:
1. **AND 그룹**: AI 도구 = `ComfyUI`
2. **AND 그룹**: 모델명 포함 = `animagine`
3. **AND 그룹**: General 태그 `best quality` (점수 0.5 ~ 1.0)

### 예시 5: 정규식을 사용한 복잡한 검색

**목표**: 여러 소녀 이미지, 특정 프롬프트 패턴

**필터 구성**:
1. **OR 그룹**: 긍정 프롬프트 정규식 = `^\d+girl` (1girl, 2girls 등)
2. **AND 그룹**: 긍정 프롬프트 포함 = `masterpiece`
3. **제외 그룹**: 네거티브 프롬프트 정규식 = `nsfw|explicit`

### 예시 6: 점수 범위를 활용한 정밀 필터링

**목표**: 고신뢰도 solo 이미지, Rating general 고점수

**필터 구성**:
1. **AND 그룹**: General 태그 `solo` (점수 0.8 ~ 1.0)
2. **AND 그룹**: General 태그 `1girl` (점수 0.8 ~ 1.0)
3. **AND 그룹**: Rating 타입 = `general` (점수 0.9 ~ 1.0)

## 📖 정규식 패턴 가이드

### 기본 패턴

| 패턴 | 설명 | 예시 |
|------|------|------|
| `text` | 정확한 텍스트 매칭 | `girl` → "girl" 매칭 |
| `text1\|text2` | OR 조건 | `cat\|dog` → "cat" 또는 "dog" |
| `^text` | 시작 부분 매칭 | `^master` → "masterpiece" 매칭 |
| `text$` | 끝 부분 매칭 | `quality$` → "best quality" 매칭 |
| `.` | 임의의 한 문자 | `1.girl` → "1girl", "1_girl" 등 |
| `.*` | 0개 이상의 임의 문자 | `low.*quality` → "low quality", "lowres quality" |

### 유용한 패턴 예시

```regex
# 숫자girl 패턴 (1girl, 2girls 등)
^\d+girls?

# nsfw 또는 explicit 제외
nsfw|explicit

# quality로 끝나는 모든 단어
\w+quality

# masterpiece 또는 best quality
masterpiece|best\s+quality

# 괄호 안의 숫자 (embedding weight)
\([\d.]+\)

# 특정 단어로 시작
^(masterpiece|best quality|high quality)
```

## 🎨 점수 범위 활용 방법

### 점수 범위란?

- **범위**: 0.0 ~ 1.0
- **의미**: WD Tagger가 해당 태그를 얼마나 확신하는지
- **0.0**: 거의 확신 없음
- **1.0**: 매우 높은 확신

### 권장 점수 범위

| 용도 | 권장 범위 | 설명 |
|------|----------|------|
| **엄격한 필터** | 0.8 ~ 1.0 | 매우 확실한 경우만 |
| **일반 사용** | 0.5 ~ 1.0 | 적당한 신뢰도 |
| **넓은 검색** | 0.3 ~ 1.0 | 가능성 있는 모든 경우 |
| **Rating** | 0.7 ~ 1.0 | Rating은 높은 신뢰도 권장 |
| **캐릭터** | 0.75 ~ 1.0 | 캐릭터 인식은 높은 신뢰도 필요 |

### 점수 범위 팁

```
✅ 좋은 예:
- General 태그 "solo": 0.5 ~ 1.0 (일반적)
- Character 태그: 0.8 ~ 1.0 (높은 확신 필요)
- Rating: 0.7 ~ 1.0 (등급은 정확해야 함)

❌ 피해야 할 예:
- 모든 조건에 0.9 ~ 1.0 (너무 엄격, 결과 없을 수 있음)
- 캐릭터에 0.3 ~ 1.0 (잘못된 인식 포함 가능성)
```

## ❓ 자주 묻는 질문

### Q1. 제외 그룹과 AND 그룹의 차이는?

**A**:
- **제외 그룹**: 조건에 맞는 것을 **제외**합니다 (NOT)
- **AND 그룹**: 조건에 맞는 것을 **포함**합니다 (필수 조건)

예시:
- 제외: `nsfw` → nsfw 태그가 **없는** 이미지만
- AND: `1girl` → 1girl 태그가 **있는** 이미지만

### Q2. OR 그룹에 여러 조건을 추가하면?

**A**: **하나라도 만족하면 포함**됩니다.

예시:
- OR: `1girl` (점수 0.5~1.0)
- OR: `2girls` (점수 0.5~1.0)
→ 1girl이거나 2girls인 이미지 모두 포함

### Q3. AND 그룹이 여러 개 있으면?

**A**: **모두 만족해야 포함**됩니다.

예시:
- AND: `solo`
- AND: `캐릭터 존재 = 있음`
- AND: `Rating = general`
→ 세 조건을 **모두** 만족하는 이미지만 포함

### Q4. 필터 순서가 중요한가요?

**A**: 그룹 타입의 **실행 순서**는 고정되어 있습니다:
```
제외(NOT) → OR → AND
```

같은 그룹 내의 개별 필터 순서는 결과에 영향을 주지 않습니다.

### Q5. 정규식이 작동하지 않아요

**A**: 정규식 특수 문자를 이스케이프해야 합니다:

```
✅ 올바른 예:
- text1|text2 (OR)
- ^\d+girl (숫자로 시작)
- low.*quality (중간에 무엇이든)

❌ 흔한 실수:
- (1girl) → \(1girl\) (괄호 이스케이프 필요)
- $100 → \$100 (달러 기호 이스케이프 필요)
```

### Q6. 점수 범위를 어떻게 설정하나요?

**A**: 슬라이더로 조정하거나 직접 입력할 수 있습니다:

- **최소 점수**: 이 점수 이상인 경우만 매칭
- **최대 점수**: 이 점수 이하인 경우만 매칭
- **0.0 ~ 1.0**: 모든 점수 허용

팁: 처음에는 넓은 범위(0.3~1.0)로 시작하고, 결과를 보며 조정하세요.

### Q7. 자동수집과 검색의 차이는?

**A**:
- **자동수집**: 새로 업로드되는 이미지를 자동으로 그룹에 추가
- **검색**: 기존 이미지를 필터 조건으로 찾기

동일한 복합 필터 시스템을 사용하지만 용도가 다릅니다.

### Q8. 필터가 너무 많아 느려요

**A**: 성능 최적화 팁:
1. **제외 그룹**을 먼저 사용 (가장 효율적)
2. 불필요한 조건 제거
3. 점수 범위를 적절히 설정 (너무 넓으면 느림)
4. 정규식보다 포함 조건 선호 (더 빠름)

### Q9. 프롬프트가 없는 이미지는?

**A**: 프롬프트 조건은 AI 생성 이미지에만 적용됩니다:
- ComfyUI, NovelAI, Stable Diffusion 등의 메타데이터가 있는 경우
- 일반 이미지는 프롬프트 조건과 매칭되지 않습니다

대신 **자동태그 조건**을 사용하세요 (WD Tagger 필요).

### Q10. 자동태그가 없는 이미지는?

**A**:
- 자동태그 조건은 WD Tagger로 분석된 이미지에만 적용됩니다
- "자동태그 존재 = 없음" 조건으로 미분석 이미지를 찾을 수 있습니다
- 설정에서 WD Tagger를 활성화하고 이미지를 분석하세요

## 💡 추가 팁

### 효율적인 필터 구성 순서

1. **제외 조건 먼저** - 불필요한 이미지를 빠르게 제거
2. **OR 조건으로 범위 확장** - 원하는 이미지 유형 선택
3. **AND 조건으로 정제** - 정확한 조건 추가

### 필터 테스트 방법

1. 간단한 조건으로 시작
2. 검색 페이지에서 결과 확인
3. 점진적으로 조건 추가/조정
4. 만족할 때까지 반복

### 자동수집 설정 시 주의사항

- 너무 넓은 조건은 원하지 않는 이미지를 포함할 수 있습니다
- 테스트 후 자동수집을 활성화하세요
- 주기적으로 그룹을 검토하고 조건을 조정하세요
